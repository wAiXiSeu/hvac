## Context

本项目旨在开发一个本地化的三恒系统（恒温、恒湿、恒氧）控制管理系统。系统通过 Modbus TCP 协议与三恒设备通信，提供 Web 界面供用户本地控制。

**当前状态：**
- 三恒设备通过 Modbus TCP 提供控制接口
- 设备 IP：192.168.110.200，端口：502（可配置）
- 已有完整的寄存器映射表（见 docs/modbus.jpg）

**约束条件：**
- 纯本地运行，无需互联网连接
- 支持主流浏览器访问
- 轻量级部署（目标：树莓派或小型服务器）

## Goals / Non-Goals

**Goals:**
- 实现 Modbus TCP 连接管理（可配置 IP/端口）
- 提供实时环境数据监测（PM2.5、CO2、室温等）
- 支持系统级控制（开关机、模式切换、风速调节）
- 支持分房间温度设定与监控
- 友好的 Web 用户界面

**Non-Goals:**
- 云端集成与远程访问
- 用户认证与权限管理
- 数据持久化与历史记录
- 高级智能控制算法

## Decisions

### 1. 技术栈选择

| 组件 | 技术选型 | 理由 |
|------|----------|------|
| 后端框架 | FastAPI | 轻量、异步友好、自动生成 API 文档 |
| Modbus 库 | pymodbus | Python 生态最成熟的 Modbus 库，支持 TCP/RTU |
| 前端框架 | React | 用户指定，生态成熟 |
| 通信方式 | HTTP REST | 简单易用，前端集成方便 |

**替代方案考虑：**
- Flask vs FastAPI：FastAPI 原生支持异步，更适合 Modbus 轮询场景
- Vue vs React：用户明确选择 React

### 2. 系统架构

```
┌─────────────────────────────────────────────────────────────┐
│                      系统架构图                               │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│   ┌──────────────┐     ┌──────────────────────┐           │
│   │              │     │                      │           │
│   │   浏览器    │────▶│   FastAPI 后端       │           │
│   │  (React)    │◀────│   Python             │           │
│   │              │     │                      │           │
│   └──────────────┘     └──────────┬───────────┘           │
│                                   │                        │
│                            ┌──────▼───────┐               │
│                            │  Modbus TCP │               │
│                            │   Client    │               │
│                            └──────┬───────┘               │
│                                   │                        │
│                            ┌──────▼───────┐               │
│                            │  192.168     │               │
│                            │  .110.200    │               │
│                            │  :502         │               │
│                            └──────────────┘               │
└─────────────────────────────────────────────────────────────┘
```

### 3. 数据模型

**设备配置：**
```python
ModbusConfig:
  - host: str (默认: "192.168.110.200")
  - port: int (默认: 502)
  - slave_id: int (默认: 1)
  - timeout: int (默认: 5秒)
```

**核心寄存器映射：**
| 地址 | 名称 | 读写 | Scaling |
|-----|------|------|---------|
| 41033 | 系统总电源 | RW | 1 |
| 41034 | 在家/离家模式 | RW | 1 |
| 41041 | 运行模式 | RW | 1 |
| 41047 | 新风风速设定 | RW | 1 |
| 41090 | 客厅设定温度 | RW | 0.5 |
| 41101 | 主卧设定温度 | RW | 0.5 |
| 41110 | 次卧设定温度 | RW | 0.5 |
| 41123 | 书房设定温度 | RW | 0.5 |
| 41024 | 室内 PM2.5 | RO | 1 |
| 41026 | 室内 CO2 | RO | 1 |
| 41085 | 客厅实际温度 | RO | 0.1 |
| 41087 | 客厅实际湿度 | RO | 0.1 |

### 4. API 设计

| Method | Endpoint | 描述 |
|--------|----------|------|
| GET | /api/config | 获取 Modbus 配置 |
| PUT | /api/config | 更新 Modbus 配置 |
| GET | /api/status | 获取连接状态 |
| GET | /api/environment | 获取环境数据 |
| GET | /api/system | 获取系统状态 |
| PUT | /api/system | 设置系统控制 |
| GET | /api/rooms | 获取房间状态 |
| PUT | /api/rooms/{room_id} | 设置房间温度 |

## Risks / Trade-offs

| 风险 | 影响 | 缓解措施 |
|------|------|----------|
| Modbus 连接不稳定 | 控制响应延迟 | 实现重连机制，超时配置 |
| 寄存器地址变更 | 功能失效 | 配置化管理，支持热更新 |
| 并发控制冲突 | 设备响应异常 | 添加操作锁，避免频繁请求 |
| 浏览器兼容性 | UI 显示异常 | 使用现代浏览器，响应式布局 |

## Open Questions

- [ ] 是否需要支持多个 Modbus 设备？
- [ ] 轮询间隔建议设置为多少？（当前建议 2-5 秒）
- [ ] 是否需要离线模式支持（网络断开时降级显示）？
